# 配置主从库

1. 修改主库配置文件
    
    ```bash
    [mysqld]
    server-id=1
    log-bin=mysql-bin
    binlog-do-db=qd
    gtid_mode=ON
    enforce-gtid-consistency=ON
    expire_logs_days=7
    ```
    
2. 重启MySQL服务
3. 创建备份用户
    1. `CREATE USER 'repl'@'%' IDENTIFIED BY 'replQuantaEye_123';`
    2. `GRANT REPLICATION SLAVE ON **.** TO 'repl'@'%';`
    3. `FLUSH PRIVILEGES;`
4. 导出数据
    1. `FLUSH TABLES WITH READ LOCK;`
    2. `SHOW MASTER STATUS;`
    3. `mysqldump -u <username> -p <dbname> --master-data=2 --single-transaction > dump.sql`
    4. `UNLOCK TABLES;`
5. 修改从库配置文件
    
    ```bash
    server-id=2
    gtid_mode=ON
    enforce-gtid-consistency=ON
    expire_logs_days=7
    read_only = 1
    master_info_repository=TABLE
    relay_log_info_repository=TABLE
    ```
    
6. 重启MySQL服务
7. 导入数据
    1. `reset master;` 
    2. `mysql -u <username> -p <dbname> < dump.sql`
    3. `change master to master_host='<master_ip>',master_user='repl',master_password='replQuantaEye_123',master_auto_position=1;`
    4. `START SLAVE;`
    5. `SHOW SLAVE STATUS\G`
    6. `STOP SLAVE;`
    7. `reset slave all;` 彻底清除同步信息

### 参考：

- -set-gtid-purged
    
    控制是否在备份文件中添加SET @@GLOBAL.GTID_PURGED语句。
    
    1. set-gtid-purged=0|off 不添加。
    2. set-gtid-purged=1|on 如果gtid没有开启，则报错;如果开启gtid，则添加。
    3. 如果没有提供set-gtid-purged,默认是auto，如果gtid没有开启，不添加；如果开启gtid,则添加。
    
    我们备份，就是可能需要拿来进行恢复，是在master上恢复，还是slave上恢复。
    
    如果是在master上进行恢复，那么就需要生成对应的gtid,所以需要使用set-gtid-purged=off
    
    如果是在slave上进行恢复，那么不需要生成对应的gtid，所以需要使用set-gtid-purged=on
    
- -master-data
该选项将当前服务器的binlog的位置和文件名追加到输出文件中(show master status)。
如果为1，将会输出CHANGE MASTER 命令；如果为2，输出的CHANGE MASTER命令前添加注释信息。
该选项将打开--lock-all-tables 选项，除非--single-transaction也被指定（在这种情况下，全局读锁在开始导出时获得很短的时间；其他内容参考下面的--single-transaction选项）。
该选项自动关闭--lock-tables选项。
- -single-transaction
该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN 不会阻塞任何应用程序且能保证导出时数据库的一致性状态。它只适用于多版本存储引擎，仅InnoDB。
本选项和--lock-tables 选项是互斥的，因为LOCK TABLES 会使任何挂起的事务隐含提交。要想导出大表的话，应结合使用--quick 选项。
mysqldump -uroot -p --host=localhost --all-databases --single-transaction
